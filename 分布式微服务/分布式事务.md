以订单-购物车为例：
1. 订单库插入订单数据
2. 发送消息队列
3. 购物车系统消费消息，清理购物车

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-22-150110.jpg)
### 使用消息队列实现分布式事务
- 适用范围
	- 异步更新数据
	- 对数据实时性要求不高

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-22-145251.jpg)

- 订单系统在消息队列上开启一个事务
- 订单系统给消息服务器发送一个半消息
	- 半消息指事务提交前，对于消费者说，这个消息是不可见的
- 订单系统执行本地任务

### RocketMQ 的分布式事务实现
- Producer 在提交或者回滚事务消息时发生网络异常时，Broker 没有收到提交或者回滚的请求，Broker 会定期去 Producer 上反查这个事务对应的本地事务状态
- 根据反查结果决定提交还是回滚
-业务代码需要实现反查本地事务状态的接口

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-22-152754.jpg)