# ELB - Elastic Load Balance 弹性负载均衡器

## 为什么需要负载均衡

- 分散多个下游实例
- 对外只提供一个访问点
- 具有一些运行状况检查机制, 并且可以了解哪些实例不能向其发送流量，可以无缝地处理下游实例的故障
- 可以对实例进行运行状况检查
- 可作为 SSL 终端使用
- 可以通过Cookie强制实现粘性､ 跨区域的高可用性, 并将公共流量与云上的私有流量分开

- 弹性负载均衡器被 AWS 管理
- AWS负责升级､ 维护和高可用性
- 它会提供一些配置旋钮来调整负载平衡器的行为
- 集成了其他 AWS 产品

## 健康检查

- 运行状况检查是弹性负载均衡器验证EC2实例是否正常工作的一种方式，如果它工作不正常， 我们就不想向该实例发送任何流量｡
- 通过使用端口和路由来检查运行状况
- 它被标记为不健康，并将被终止，同时ASG启动一个新的EC2实例

## AWS 弹性负载均衡器的种类

- Classic Load Balancer 传统负载均衡器 - CLB - 2009
	- 它与HTTP､ HTTPS､ TCP､SSL或安全CP兼容
	- 已弃用
- Application Load Balancer 应用负载均衡器 - ALB -2016
	- 支持HTTP､ HTTPS和web套接字协议
- Network Load Balancer 网络负载均衡器 - NLB -2017
	- 支持TCP､ TLS､ 安全CP和UDP协议｡
- GateWay Load Balancer 网关负载均衡器 - GWLB -2020


### Application Load Balancer  应用负载均衡器 

- 基于 HTTP 协议
- 允许跨计算机路由到多个HTTP应用程序
- 延迟 400 ms
- 可以对同一EC2实例上的多个应用程序进行负载平衡
- 支持HTTP/2和WebSockets
- 支持重定向
- 支持路由表
	- 通过 URL 路由
	- 通过域名路由
	- 通过参数路由
- 非常适合微服务和基于容器的应用程序
- 具有端口映射功能，能够重定向到ECS实例上的动态端口

#### 应用负载均衡器目标组

- ALB可以根据
	- URL路径
	- 主机名
	- HTTP头信息
	- 查询字符串
- 将流量导向不同的目标组

- EC2实例
- ECS 任务
- Lamda 函数
- IP 地址 (必须是私有)

- ALB可以路由到多个目标组
- 运行状况检查将在目标组级别完成


### Network Load Balancer 网络负载均衡器

- 允许TCP和UDP流量，基于 TCP / UDP
- 性能非常高，每秒数百万请求，延迟100ms
- NLB 会给每个AZ分配一个静态IP
- 不免费

#### 网络负载均衡器的目标组

- EC2实例
- IP 地址 (必须是私有)
- 在应用程序负载平衡器之前使用网络负载平衡器
	- 借助 BLB 可以获得固定的IP地址, 而借助ALB, 您可以获得处理HTTP类型流量的所有规则
- 健康检查支持 TCP、HTTP、HTTPS


### GateWay Load Balancer 网关负载均衡器

- 可用于在AWS中部署､ 扩展和管理您的第三方网络､ 中立设备群
- 所有流量可以先进入 GWLB
- GWLB 运行于 IP 网络层

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/2023-05-12-031737.png)

#### 网关负载均衡器的目标组

- EC2实例
- IP 地址 (必须是私有)


## 粘性会话

- 称为弹性负载均衡器的会话关联
- 其思想是向负载均衡器发出两个请求的客户端将在后端具有相同的实例来响应请求

- 原理
	- cookie 会跟随请求发送，其中包含粘性的到期时间
	- 粘性到期时间之前，请求都会保证请求的是啥同一个后端实例

- 开启粘性会话可能会带来负载不平衡

## Cookie 名称

- 基于应用程序的 Cookies 
	- 自定义 Cookie
		- 有目标生成的自定义 cookies 
		- 可以包含自定义属性
		- 不能使用 AWSALB､AWSALBAPP或AWSALBTG 名称
	- 应用程序 Cookie
		- 时间将由负载均衡器本身生成｡
- 基于持续时间的 Cookies 
	- 由负载均衡器生成的cookie
	- 名字是AWSALB代表ALB, AWSELB代表CLB


## 跨区负载平衡

- 允许 ELB 跨 AZ 进行负载均衡
- ALB
	- 默认启用跨区
	- 不需要收费
- NLB、GWLB
	- 默认禁用跨区
	- 需要付费


## SSL 证书

- SSL是指安全套接字层，用于加密传输连接
- TLS是SSL的更新版本
- SSL 有一个到期时间，必须定期更新

- 负载均衡器加载一个 X.509 证书，称为 SSL 或  TSL 证书
- 可以使用 ACM  证书管理器管理这些证书
- HTTPS 监听器
	- 必须指定默认证书
	- 可以添加一个可选的证书列表来支持多个域名
	- 客户端可以使用 SNI 指定要访问的服务器


### SNI  Server Name Indication

- SNI 处理了将多个 SSL 证书加载到一个服务器上
- 使用了一个新的小写意，在 SSL 握手中要求指定目标服务器的主机名
- 只有使用了 ALB 和 NLB 、CloudFont 才可使用


- 使用传统负载均衡器，只能支持 1个 SSL 证书
- 如果需要支持多个  SSL 证书，只能使用 ALB 、NLB


## 连接清空

- 传统负载均衡器，称为 连接耗尽
- 应用负载均衡器 / 网络负载均衡器，称为注销延迟
- 在实例被注销或标记为不正常时, 它将为您的实例给予一些时间来完成正在进行的请求或活动的请求
- 一旦实例被清空, ELB将停止向注销时被清空的EC2实例发送请求


# ASG Auto Scaling Group 自动扩展组

- ASG的目标是横向扩展, 这意味着添加EC2实例
- 如果将其与负载平衡器配对, 则作为ASG一部分的任何EC2实例都将链接到负载平衡器
- 如果一个实例被认为是不健康的, 它将被终止，并创建一个新的EC2实例来替换它

- 最小容量、最大容量


## CloudWatch 与 自动扩展集成

- 基于CloudWatch警报的ASG可以进行横向扩展和纵向扩展
- 触发警报的指标
	- 平均CPU
	- 自定义

### 指标

- CPU Utilizaiton - CPU 利用率
- RequestCountPerTarget 每个目标的请求数量
- Average NetWork In / Out 网络的上传或下载

## 自动缩放策略

- 动态扩展策略
	- Target Tracking Scaling 目标跟踪缩放
		- 平均CPU利用率 保持在 40%
	- Simple / Step Scaling 简单/逐步缩放
		- 设置 CloudWatch 警报， CPU 占用率 > 70% ，添加一个单元容量
		- 设置 CloudWatch 警报， CPU 占用率 < 30% ，删除一个单元容量
	- 计划动作
		- 根据已知的用户模式预测扩展

## 预测缩放

- 预测负载趋势，提前进行扩展


## 扩展冷却时间

- 默认情况下为5分钟或300秒
- 在冷却时间呢，  ASG将不会启动或终止其他实例
- 建议使用现成的 AMI 缩短 EC2 实例的启动时间

## 实例刷新

- 想要更新整个自动缩放组
- 创建新的启动模板，然后使用实例刷新功能
- 主键停止旧的实例，启用新的实例
