# 什么是 EC2 

- EC2是AWS最受欢迎的产品之一
- 它代表弹性计算云，这是在AWS上实现基础架构即服务的方法
- 由许多高层次的东西组成
	- EC2上租用虚拟机 （EC2）
	- 以将数据存储在虚拟驱动器（EBS） 
	- 跨计算机分配负载, 即弹性负载平衡器 （ELB）
	- 自动扩展组来扩展服务 （ASG）


# EC2 的设置选项

- 操作系统 OS：Linux、Windows、Mac
- CPU
- RAM 内存
- 存储空间
- 网卡
- 防火墙规则
- 启动脚本 （启动时配置，如用户数据等）

# EC2 User data

- 使用EC2用户数据脚本引导我们的实例启动
- 用户数据脚本仅在第一次启动时运行一次，之后将永远不会再次运行
- 常见启动任务
	- 安装更新
	- 安装软件
	- 下载常用文件
	- 其他你想做的事情
- EC2 用户数据脚本只能以 root 身份运行
-  http://169.254.169.254/latest/user-data 查询用户数据


# 元数据

- 实例元数据可以从你的运行实例中获得，你不需要使用Amazon EC2控制台或AWS CLI
- http://169.254.169.254/latest/meta-data/

# EC2 实例类型

## 7 种实例类型

- 通用
	- 通用实例提供计算、内存和联网资源三方面的平衡，可用于各种不同的工作负载。这些实例非常适合于以相同比例使用这些资源的应用程序，如 Web 服务器和代码存储库。
- 计算优化型
	- 算优化型实例非常适用于从高性能处理器获取的受计算限制的应用程序。 属于此类别的实例非常适用于批处理工作负载、媒体转码、高性能 Web 服务器、高性能计算 (HPC)、科学建模、专用游戏服务器和广告服务器引擎、机器学习推理和其他计算密集型应用程序。
- 内存优化型
	- 内存优化型实例旨在提高可处理内存中大型数据集的工作负载的性能。
- 加速计算
	- 加速计算实例使用硬件加速器或协同处理器来执行浮点数计算、图形处理或数据模式匹配等功能，比使用在 CPU 上运行的软件更高效。
- 存储优化
	- 存储优化型实例旨在用于需要对本地存储上的大型数据集进行高速连续读写访问的工作负载。它们经过了优化，每秒可以向应用程序交付数以万计的低延迟、随机 I/O 操作 (IOPS)。
- HPC 优化
	- 高性能计算（HPC）实例专为在 AWS 上大规模运行 HPC 工作负载提供最佳性价比而构建。HPC 实例特别适用于从高性能处理器（如大型复杂模拟和深度学习工作负载）中受益的应用程序。  
- 实例特征

## 实例选择

- 预留实例
	- 预留实例可大幅节约您的 Amazon EC2 成本
	- 留实例不是物理实例，而是对账户中使用的按需型实例所应用的账单折扣。这些按需型实例必须与特定属性（例如实例类型和区域）匹配才能享受账单折扣。
	- 有固定的期限承诺
- 专属实例
	- 在虚拟私有云（VPC）中运行的
	- 其硬件是专门为单个客户提供的
	- 属于不同AWS账户的专用实例在硬件层面上是物理隔离的
- 专用主机
	- 是一个具有EC2实例容量的物理服务器，完全专供您使用。
	- 专用主机允许你在EC2实例上使用你现有的软件许可证。
	- 使用专用主机，您可以看到并控制实例在服务器上的放置方式。这个选项比专用实例的成本高
- 现货实例
	- 现货实例是一个未使用的EC2实例，其价格低于按需分配的价格。
	- 只要有容量，并且您的请求的每小时最高价格超过现货价格，您的现货实例就会运行。
	- 任何存在未使用容量的实例将被分配
- 按需实例
	- 通过按需实例，你按秒支付计算能力，没有长期承诺。
	- 你可以完全控制它的生命周期，你可以决定何时启动、停止、休眠、启动、重启或终止它。
	- 硬件隔离是不可能的
	- 按需分配是最昂贵的实例收费之一

## AWS 命名约定

eg: m5.2xlarge

- M：实例类型
- 5：代数
- 2xlarge：代表实例大小


# 安全组

- 安全组是AWS云中网络安全的基础
- 控制如何允许流量进出您的EC2实例
- 只包含允许规则
- 安全组可以通过IP地址或引用其他安全组的规则 
- 安全组是EC2实例上的防火墙
	- 管理对端口的访问
	- 可以看到授权的IP范围
	- 控制入站流量
	- 控制出站流量

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/2023-05-10-033102.png)


## 小结

- 安全组可以连接到多个实例，一个实例也可以有多个安全组
- 安全组只属于一个区域/VPC 组合
- 如果流量被阻塞，实例无法感知
- 安全组实际上市运行在实例外部的防火墙
- 只为 SSH 访问维护一个单独的安全组
- 如果应用不可访问，返回了请求超时，可能是安全组有问题
- 如果应用返回了连接错误，则安全组正常工作，但应用可能出现问题，比如启动失败
- 所有入站流量安全组默认阻塞
- 所有出站流量安全组默认通过

## 常用的端口号

- 22：SSH（Secure Shell）   --  登录 Linux 实例
- 21： FTP  (File Transfer Protocol) --  文件上传、文件共享
- 22：SFTP (Secure File Transfer Protocol) -- 安全文件传输
- 80：HTTP 
- 443： HTTPS
- 3389： RDP (Remoet Desktop Protocol)  -- 登录 Windows 实例



# EC2 存储 

## 什么是 EBS (Elastic Block Store )

- Elastic Block Store 代表弹性块存储，是一个网络驱动器
- 实例终止后，EBS 也能保存数据，重新创建新的实力，加载相同的 EBS 卷，可以取回数据
- 通过网络和实例连接，是网络驱动程序 ，类似与一个网络U盘
- 可以在不同区域移动 EBS 卷
- 需要提前配置容量，并且按容量收费

## EBS  Snapshots 快照

- EBS 快照是 EBS 卷在任意时间点的备份
- 通过 EBS 快照，可以在另一个实例中恢复 EBS 中的数据

## EBS 快照特性

- EBS Sanpshot Archive - EBS 快照归档
	- 移动快照到归档层成本最多可降低 75%
	- 从归档层中恢复快照需要 24 -72 小时
- 回收 EBS 快照
	- 回收站可以恢复删除的卷
	- 回收站保留时间 一天 - 一年
- Fast Snapshots Restore (FSR) 快速快照恢复
	- 如果快照非常大，需要快速恢复
	- 此功能需要花费大量资金

## EBS 卷类型

- 6种 EBS 卷
	- gp2/g3 (SSD)
		- 针对各种工作负载平衡价格和性能
	- io1/io2 (SSD)
		- 用于任务关键型､ 低延迟和高吞吐量工作负载
	- st1 (HDD)
		- 低成本
		- 专为频繁访问的吞吐量密集型工作负载而设计
	- sc1(HDD)
		- 成本最低的HDD卷,
		- 并且将针对访问频率较低的工作负载而设计

- 如何选择
	- 大小 
	- 吞吐量
	- IOPS （OPS是指每秒的I/O操作数）

> **只有gp2和gp3以及io1和io2可以用作引导卷**


### Genral Purpose SSD

- gp是一种低延迟､ 经济高效的存储, 您可以将其用于系统启动卷、虚拟桌面､ 开发和测试环境
- 大小 1GB - 16TB 变化

- gp3 
	- 3000 IOPS 基准 
	- 每秒125MB 吞吐
	- 可提高至 16000 IOPS、每秒 1000MB
	- 可独立设置 IOPS 和吞吐，不与卷大小关联
- gp2
	- 最高 3000 IOPS
	- IOPS 的高低与卷的大小相关，提高 IOPS 需要增加卷的容量
- io1/io2
	- 4 - 16 TB 大小
	- 最大 IOPS 60000 IOPS （Nitro EC2 实例）
	- 可以独立存储调配 IOPS
	- 其他实例，32000 最大 IOPS 
	- io2 更耐用、更高的 IOPS 每G 
- io2 Block Express 
	- 4 - 64 TB
	- 亚毫秒级延迟
	- 最大 256000 IOPS / GB

### Hard Disk Drives (HDD) 

- 不能作为启动盘
- 125 GB - 16 TB
- st1
	- 吞吐优化型硬盘 
	- 适合大数据、数据仓库存储、日志处理
	- 每秒 500 MB 最大吞吐、500最大 IOPS
- sc1
	- 冷硬盘
	- 用于归档数据、不常访问的数据
	- 最大吞吐 250 MB 、最大IOPS 250

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/2023-05-11-124223.png)

## EBS 卷多连接 Multi-Attach

- 相同的EBS卷连接到同一可用性区域中的多个EC2实例
- 多实例可以同时进行读写操作
- 获得了更高的可用性
- 仅在当前的区域可用
- 一次最多连接16个实例
- 必须使用一个支持集群的文件系统



# AMI Amazon Machine Image

## AMI 概述

- AMI ：亚马逊机器映像
- AMI 是对 EC2 实例的定制化
	- 可以添加自定义的软件、配置、操作系统、镜像等
	- 更快的启动时间、配置时间
- AMI 必须指定区域进行构建
- EC2 实例可以运行在
	- 公共 AMI : AWS 提供
	- 自定义的 AMI
	- AWS AMI 供应商

## AMI 如何工作

- 启动一台 EC2 实例，并且进行自定义
- 停止实例
- 构建AMI 
- 创建一台新实例，并以 AMI 进行启动
- 复制了

# EC2 Instance Store 实例存储

- 直接连接物理磁盘
- 又更好的 I/O性能
- 停止或终止EC2实例，实力存储将会丢失
- 不适合长期存储
- 确保备份


# EFS - Elastic File System 弹性文件系统

- 它是一个网络文件系统
- 可以装载在不同的可用性区域中的多个实例总
- 它具有 高可用、可扩展性
- 价格昂贵，是gp2 EBS 的3倍
- 不需要提前调配容量

-  使用案例
	- 内容管理
	- WEB 服务
	- WordPress
- 使用 NFS (Netword File System) 协议
- 需要安全组对 EFS 进行访问控制
- 目前只兼容 Liunx 的 AMI
- 可使用 KMS 在 EFS 驱动器中启用静态加密


## EFS  特性

- EFS 自动扩展
	- 可连接1000个以上 NFS 客户端
	- 10 GB 以上的吞吐
	- 可自动扩展到 PB 级
- EFS 性能模式
	- 通用，默认设置
		- 延迟敏感的用例：web 服务器\ CMS 
	- MAX I/O 
		- 高延迟
		- 吞吐量更高
		- 高度并行
		- 适用于：大数据、媒体处理
- 吞吐量模式

## EFS 存储

- 存储层 ：在几天后将文件移动到不同的层｡
	- 标准层：频繁访问
	- EFS-IA：不频繁访问，更便宜
		- 必须使用生命周期策略
- 可用性和持久性
	- 通用：多可用区间可用
	- 单区：只有一个可用区
		- 默认启动备份
		- 可与存储层兼容

# EBS 与 EFS 的区别

- EBS 
	- 一次连接到一个实例
		- 特例：io1、io2 可以进行多连接
	- 只能单个可用区中使用
	- 跨可用区需要使用 EBS 快照进行复制卷
	- EBS 备份时会占用 IO
	- 默认情况下 EC2 实例终止，EBS 卷会被终止，需要修改默认设置
- EFS
	- 它是一个网络文件系统
	- 可跨可用区连接数百个实例
	- 只试用于 Liunx 实例，因为它基于 POXIS 系统
	- EFS 比 EBS 贵，可使用 EFS-IA 节省成本