# GateWay

- 这是AWS提供的无服务器产品, 允许我们创建REST API, 这些API将是公共的, 可供我们的客户访问

- 集成API Gateway 和 Lambda ，将提供一个完整的无服务器应用程序
- 支持WebSocket协议
- 可以处理API版本控制 
- 处理多个环境
- 身份验证和授权启用安全性
- 创建API密钥,


# 网关集成

- Lambda 函数
	- 执行Lambda 函数
	- 公开REST（一种由Lambda函数支持的API）的最常见和最简单的方式
- HTTP
	- 可以在后端公开任何HTTP端点
	- 可以是内部部署的HTTP API
	- 也可以是云环境中的应用负载平衡器
- AWS service
	- 以直接从API网关API向SQS发布消息


# 端点类型

- Edge-Optimized (default) 边缘优化：全球客户
	- 请求将通过所有CloudFront Edge位置进行路由，改善延迟
	- API网关仍然只位于创建它的一个区域
- Regional 区域部署
	- 所有用户都在我们创建API网关的同一区域内
- Private 私有 API 网关
	- 只能从VPC内部 使用ENI的接口VPC端点 访问私有API网关

# 安全性

- 用户认证授权
	- IAM 角色 （内部应用）
	- Cognito  （外部用户 移动端）
	- 自定义授权 （Lambda函数）
- 自定义域名 Https


# 部署

## 阶段

- 更改网关，只有网关部署时才会生效
- 更改被部署到各个阶段, 您可以拥有任意多个阶段 stages
- 每个阶段都将获得自己的配置参数, 并且可以无缝地回滚。
- 在一个阶段上发生的所有部署的完整历史记录都被保留下来


### 阶段变量

- API 网关的环境变量
- 更改配置值, 而无需重新部署API
- 可以被用在：
	- Lambda 函数的 ARN
	- HTTP 端点
	- 参数映射模板
- 使用场景
	- 自动配置与您的stages通信的HTTP端点 dev、test、prd
	- 通过参数映射模板将参数传递给 Lambda 函数
- 这些阶段变量将被传递给Lambda函数中的 context 对象
- 格式：${stageVariables.variableName}


## Canary 金丝雀（灰度）部署

- 对API网关所做的更改上测试少量流量


## 集成类型

- Mock
	- 不向后端发送请求
	- 对API Gateway进行编程和配置，并且还不想在后端进行任何工作时
- HTTP / AWS (Lambda & AWS Services)
	- 必须配置所谓的集成请求和集成响应
- AWS_PROXY  aws  lambda 代理
	- 来自客户端的请求将成为Lambda的输入
	- lambda 函数只负责请求和响应的逻辑
	- 不能使用任何映射模板,不能更改头､ 查询字符串参数
	- 所有工作都在后端, API网关只是用于代理请求
- HTTP 代理
	- 请求本身直接传递, 所以代理到后端
	- API将再次代理该响应以返回到客户端
	- 可以在 http 头中添加一个API密钥

### 映射模板

- 映射模板可以修改请求和响应
	- 可以重命名或修改查询字符串参数
	- 修改正文内容
	- 添加或修改标题 
- VTL 模板语言可以使用 for循环 if 等
- 使用映射模板可以从响应中删除一些结果
- 要设置映射模板, 必须将内容类型设置为 application/json 或 application/xml

### SOAP

- SOAP API是基于XML的，而RESTAPI是基于JSON的
	- 可以通过映射模板进行格式转换


# API 响应缓存

- 当我们的客户端与API网关通信时,API网关将首先检查缓存
- 默认 TTL 300 秒 5min，最长为 1小时
- 可以为每一个 stage 定义缓存
- 缓存可以加密
- 缓存大小在 0.5 GB - 237 GB 之间
- 高速缓存非常昂贵, 因此只有在生产环境中才有意义｡

## 让缓存失效

- 可以立即从UI中使整个缓存无效
- 客户端可以使用放置在API网关中header 的 Cache-Control: max-age=0 （需要 IAM 授权）
- 允许客户端使特定资源上该高速缓存无效


# 使用计划 & API 密钥

- 使用计划
	- 创建一个使用计划, 在其中定义谁可以访问一个或多个API阶段和方法
	- 以访问的数量和速度, 以及哪些API密钥与此使用计划相关联
	- 还可以配置带宽限制
	- 每月只能完成10, 000个请求 （如果不支付额外费用）


- API密钥
	- API密钥允许您的客户安全地使用您的API网关, 并验证他们的请求
	- 如果启用了任何节流限制, 则会应用API密钥级别

## 使用计划 & API 密钥的顺序

- 首先创建一个或多个API
- 然后配置需要API密钥的方法
- 将API部署到 stage
- 然后生成或导入API密钥，分发给应用程序开发人员
- 最后, API的调用方必须在x-API-key头中提供API密钥

# 日志 & 追踪

## 日志

- CloudWatch 日志
	- 获得有关通过API网关的请求和响应主体的信息
	- 以在阶段级别启用它并定义日志级别
- X-Ray
	- 关于通过API网关的请求的跟踪信息

## CloudWatch Metrics 度量指标

- CacheHitCount
- CacheMissCount
- Count：给定时间段内的API请求数
- IntegrationLatency：API将请求中继到后端并等待从后端接收响应所需的时间
- Latency 延迟：是API网关从客户端接收请求到向客户端返回响应之间的时间
	- API网关可以执行任何请求的最长时间是**29秒**｡
- 4XX 客户端错误
- 5XX 服务端错误

# 节流 

- 账户限制 
	- 默认情况下，API网关将在所有API中以每秒10,000个请求的速度限制请求
- 节流错误码
	- 429 Too Many Requests
	- 客户端错误
- 通过 阶段限制和方法限制
	- 确保每个阶段在受到攻击时不会使用请求的所有配额
- 通过 使用计划限制


# 错误

- 4xx：客户端错误
	- 400：Bad Request
	- 403：访问被拒绝
	- 429：产出配额
- 5xx：服务端错误
	- 502
	- 503：服务不可用
	- 504：集成失败（请求超时


# CORS 

- 如果希望能够接收来自另一个域的API调用, 则必须启用CORS
- 创建一个 API 网关 预检查请求，客户端预检查通过后，可开始进行 CORS


# 安全

## IAM 权限

- API网关不使用安全组，而是使用资源策略
- 身份验证 通过 IAM，鉴权通过 IAM 策略
- 这是保护 api 网关的最佳方式
- 使用 Sign V4 

## 资源策略

- 与 Lambda 的 资源策略类似，定义谁和什么可以访问API网关
- 主要使用情形是使用跨帐户访问
- 允许指定 IP 地址或者 VPC 端点


## Cognito 用户池

- Cognito将全面管理用户生命周期, 连接Cognito的令牌将自动过期, 因此API网关将通过Cognito验证连接API的人员的身份
- 通过 Cognito 用户池 验证身份，通过  API 网关验证权限

## Lambda Authorizer

- 它是一个基于令牌的授权器
- 可以将基于请求的参数（带有标头或查询字符串）传递给Lambda授权程序
- 外部进行身份验证，Lambda 进行授权

## 总结

-  IAM
	- 帐户中创建用户和角色，如果需要跨账户，使用资源策略
	- 用于处理身份验证和授权
	- 使用了 Sign V4 技术
- 自定义验证程序
	- 非常灵活，以选择将返回的IAM策略, 并且需要在Lambda函数中启用和处理身份验证和授权
- Cognito用户池
	- 不需要写代码，首选

# WebSocket API

- 意味着在用户的浏览器和服务器之间有一个双向的交互通信


## 连接 API 

- 以wss开头的WebSocket URL, 它是一个加密的WebSocket url
- 客户端与 API 建立持久连接
- 连接将调用Lambda函数并执行连接ID
- 可以连接ID可以持久保存到AmazonDynamoDB中
- 只会通过同一连接向其发送更多消息

- WebSocket 通过路由决定调用谁


## 微服务架构

