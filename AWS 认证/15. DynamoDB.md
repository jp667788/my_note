# DynamoDB

- 一个NoSQL无服务器数据库
- 具有高可用性, 并且可以跨多个AZ进行复制
- 可以扩展到大规模工作负载, 并且是完全分布式的


## 基础

- DynamoDB是由表组成的, 每个表都有一个主键
- 每个表可以有无限多个行, 也称为项
- 每个项都拥有属性
- 每个项目, 或每行将有多达400 KB的数据
- 支持的数据类型
	- scalar 类型：String, Number, Binary, Boolean, Null
	- 文档类型：List, Map
	- 集合类型：String Set, Number Set, Binary Set

## 主键

- 分区密钥（HASH） 
	- 对于每个项必须是唯一的
	- 分区主键需要多样化
- 分区键 + 排序键 （HASH + 范围）
	- 对于每一个项目都必须是唯一的


## 写容量模式

- 是控制表容量的方法

- 资源调配模式（默认）
	- 指定每秒的读取和写入次数
	- 需要事先规划容量
	- 按每小时支付相应的费用
- 按需模式
	- 根据工作负载自动增加和减少读取和写入
	- 不需要进行容量规划、不需要调配容量单元
	- 比调配模式贵得多

- 可以每24小时在两种模式之间切换一次


### 调配模式

- 必须调配读取和写入容量单位（也称为RC 即读取吞吐量）和WCU（即写入吞吐量）
- 但是容量一旦被耗尽，会抛出 ProvisionedThroughputExceededException
- 错误会进行重试，指数回退策略

- WCU
	- 表示每秒对大小最大为1 KB 项目进行一次写入
	- 如果项目大于 1KB，就会消耗更多的 WCU
- RCU
	- 每秒一次强一致性读取 4KB 的项目，或每秒两次最终一致性读取 4KB 的项目
		- 强一致读取
			- 强一致读取会占用2倍 RCU
		- 最终一致读取

### 按需模式

- 自动接受任何读和写操作, 并将根据您的工作负载进行扩展和缩减
- 不需要进行容量规划，不指定RCU或WCU｡ 这是无限的｡

### 分区

- 当应用程序写入DynamoDB时, 应用程序将发送一个分区键，可能是一个排序键, 以及一些属性
- 通过 hash 算法，计算后确定转到哪个分区
- 计算分区数
	- RCU / 3000 + WCU / 1000
	- 数据总大小 / 10 GB
	- 上面两项中取最大值
- 分区会根据 RCU 、WCU 均匀分布
- 如果超过了RCU或WCU, 并且这是在分区级别, 那么将获得ProvisionedThroughputExceededException
	- 处理办法
		- 遇到异常时，指数级回退
		- 尽可能个更多的分区主键

## API 读写数据

### 写数据

- PutItem
	- 会创建或完全替换具有相同主键的新项
	- 消耗写入容量单位
- UpdateItem
	- 编辑现有项目，或者添加一个新的项目
	- 可以把它和原子计数器一起使用
- 条件写/更新/删除

### 读数据

- 根据主键读取
- 从两种模式种读取
	- 强一致性读
	- 最终一致性读
- 使用 ProjectionExpression 可以只接受指定的几个属性


#### 查询

- KeyConditionExpression 键条件表达式
	- 可以是一个分区主键，必须使用 = 号，必填
	- 排序键，可以是 < > <= >=，可选
- FilterExpression 过滤表达式
	- 查询操作完成之后，数据返回给您之前添加额外的筛选
	- 用于非主键属性，不能将FilterExpression与HASH或RANGE属性一起使用

#### 返回

- 返回 项目列表
- 使用 limit查询参数对检索的项目数量进行限制
- 可以使用分页
- 使用本地辅助索引或全局辅助素哟一年

#### 扫描

- 扫描项目是读取整个表
- 可以添加过滤
- 只在客户端完成
- 可以多线程进行扫描多个数据段，但是会消耗更多的 RCU
- 扫描可以使用查询、限制条件
- 也可以结合  KeyConditionExpression 、FilterExpression 使用

### 删除数据


- Delete Item
	- 删除单个项
	- 也可以根据条件删除
- DeleteTable
	- 删除整个表及其项
	- 比扫描然后删除表上的每一项要快得多

### 批量操作

- 为了提高效率，可以在DynamoDB中执行批处理操作
- 减少对数据库的API调用次数
- 批处理的一部分可能会失败，将重新收到失败的项目

- BatchWriteItem
	- 允许在一次调用中执行多达25个PutItem和/或DeleteItem
	- 最多可以写入16MB的数据
	- 但是每项依然  4KB 的限制
	- 不能更新项目
	- 如果某些项写入失败，会返回 UnprocessedItems ，可以重试其中的内容
- BatchGetItem
	- 返回一个或多个表中的项
	- 最多可以接收100项 和 16MB 的数据
	- 如果有一些项未被找到，会返回 UnprocessedKey

### PartiQL

- 使用一个标准的SQL查询
- 面向开发人员

### 条件写

- 指定一个条件表达式来决定哪些项应该被修改
- 条件
	- attributes_exists
	- attributes_not_exists
	- attribute_type
	- contains
	- begin_with
	- IN
- 筛选表达式筛选读取查询的结果


## 索引

### 本地二级索引 Local Secondary Index LSI

- LSI将为表给予一个替代排序关键字
- 排序关键字由一个标量属性组成
- 每个表最多可以获得五个LSI
- 必须在创建表的时候指定 LSI
- 在LSI上，可以拥有主表中的部分或全部属性

### 全局二级索引 Global Secondary Index GSI

- 给予你一个不同的, 另一个主键，可以使用不同的 Hash 或者 Hash + Range
- 对加快对表中非键属性的查询非常有用
- 需要为这个索引准备 RCU 、WCU
- 可以在创建表后，创建和修改 GSI


### 索引与吞吐

- 全局二级索引 GSI
	- 如果 GSI  因为流量限制写入失败阻塞，主表将也会被阻塞


## PartiQL

- 允许您使用类似SQL的语法来操作DynamoDB表
- 从DynamoDB表中插入､ 更新､ 选择或删除项
- 支持批处理操作


## DynamoDB Accelerator （DAX） 加速器

- DAX是DynamoDB的完全托管､ 高可用性和无缝内存缓存
- 缓存最常用的数据
- 读取和查询微秒级延迟
- TTL 默认为 5min
- DAX集群由节点组成
	- 最多可以有10个节点
	- 在Multi-AZ类型的设置中, 建议在生产环境中至少使用三个节点，保证每个 AZ 中有一个

### 与 ElasticCache 区别

- DynamoDB 是为单个对象､查询或扫描创建缓存
- ElastiCache 是直接从ElastiCache中检索数据, 而不是重新查询DAX和重新执行聚合客户端


## DynamoDB 流

- 流是一个有序的项目级别的修改列表
- 表示表中随时间变化的所有修改的列表
- 可以发送到多个位置，例如Kinesis数据流
- 还可以使用Lambda函数直接从DynamoDB流中读取
- 也可以使用Kinesis客户端库应用程序直接从DynamoDB流中读取
- 流中的数据保留时间最长为24小时，需要持久化到其他地方


- 可以选择哪些信息需要写入流中
	- KEYS_ONLY ：只有主键
	- NEW_IMAGE：修改后的项
	- OLE_IMAGE：修改前的整个项
	- NEW_AND_OLD_IMAGES：新旧项目图

- DynamoDB流是由碎片组成的
- 但DynamoDB Streams 不需要提供任何类型的分片
- 在启用它之后, 不会在流中追溯填充记录

### 流 和 AWS Lambda

- 需要定义一个事件源映射来从DynamoDB流读取
- 确保Lambda函数具有从DynamoDB流中提取的适当权限
- 同步调用Lambda函数


## Time To Live TTL

- “生存时间”允许您在过期时间戳之后自动删除项目
- 不会消耗任何WCU, 因此没有额外的成本
- 当项目被删除时, 它们也会从索引中删除
- 每个过期项的删除操作都进入DynamoDB流

## CLI 选项

- --projection-expression 
	- 可以指定一个或多个要检索的属性
- -- filter-expression
	- 过滤返回给你的项
- 分页选项
	- --page-size
	- --Max-items : limit
	- --starting-token: 检索接下来的数据


## 事务

- 读模式
	- 最终一致性
	- 强一致性
	- 事务
- 写模式
	- 标准：没有实物
	- 事务

- 执行一个事务, 它将消耗两倍的写容量单位和读容量单位
	- 准备事务
	- 提交事务


### 容量计算

- 每秒处理事务数 * 项目大小 / 1 * 2 

## 会话状态缓存

- DynamoDB或ElastiCache存储会话状态有什么区别
	- ElastiCache将完全在内存中
	- DynamoDB是无服务器的，可以自动扩展
- 会话状态也可以存在磁盘中
	- 多实例共享磁盘。EFS
		- EBS 不行，EBS 不能多实例共享
		- S3 也不行，延迟太高

## 写分片

- 在分区之间更好地分配候选ID，使得分布性更强

## 写类型

- 并发写
	- 可能会被覆盖
- 条件写
	- 第一个操作更新了值，可能导致写入失败
- 原子写
	- 并发安全
- 批量写
	- 并发无关，用户一次写入、更新多项

## 大对象存储

- DynamoDB 最多存储 400KB 
- 使用 S3 存储大对象
	- 处理过程
		- 先上传到 S3
		- S3 返回对象密钥
		- DynamoDB 存储密钥
- 使用 IMDB 最为索引
	- 先上传到 S3
	- 设置通知
	- lambda函数将把对象元数据存储到新的DB表中

## 操作

- 表清理
	- 扫描 + 删除项
		- 非常慢，且消耗大量 RCU
	- 删除表
		- 删除表，然后重建
		- 快速、高校、便宜
- 复制表
	- AWS 数据管道
	- 备份并恢复到新的表
		- 需要一些时间，但是高效
		- 不需要外部服务
	- 扫描 + PutItem 或 BatchWriteItem api
		- 需要自己编写代码

## 安全 和 其它特性

- 安全
	- 使用VPC端点，可以在不使用公共互联网的情况下访问DynamoDB
		- 对DynamoDB的访问完全由IAM控制
		- 可以使用AWS KMS进行静态加密, 也可以使用SSL和TLS进行传输中加密
- 备份和还原功能
		- 可以使用时间点恢复,不会对性能产生影响
- 全局表
	- 拥有一个多区域､ 多活动的完全复制的高性能表
- 本地 DynamoDB
	- 拥有一个本地DynamoDB数据库, 您可以使用该数据库在本地开发和测试应用程序
- DynamoDB 迁移服务
	- 迁移到MongoDB到DynamoDB,或动态V2 Oracle､ mySQL､ S3

- 细粒度访问
	- 联合登录来获取临时凭据, 然后我们可以创建IAM角色, 此IAM角色将具有一个条件






