## 用处

- 备份和存储
- 容灾恢复
- 归档
- 混合云存储
- 数据湖
- 大数据分析
- 托管静态网站

## Buckets 

- S3 将文件存在 bucket 中
- Buckets 名称全局唯一（所有区所有账户中）
- 在区域级别定义 buckets
- buckets 名称要求
	- 不能包含大写字母和下划线
	- 3-63 个字符之间
	- 不能是 IP 地址
	- 必须小写数字或小写字母开头


## S3 对象

- S3对象键是文件的完整路径
	- buckets 就是它的顶级目录
- 路径 = 前缀 + 对象名
- 文件最大为5TB


## S3 安全

- 基于用户
	- IAM 策略：授权特定IAM用户应允许哪些API调用
- 基于资源
	- buckets 策略：分配 buckets 的访问规则
	- ACL 对象访问控制列表：更细粒度
	- ACL buckets 访问控制列表

- IAM 主体在什么情况下可以访问
	- 如果IAM权限允许
	- 或者如果资源策略允许
	- 并且没有显式拒绝


### S3 Buckets 策略

- JSON 格式策略
	- Resources : 此策略应用于哪些存储桶和对象
	- effect：允许、拒绝
	- Actions：操作
	- pricipal：允许访问者的范围

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/2023-05-15-070102.png)


## 版本控制

- buckets 级别启用该设置
- key 相同则会覆盖，产生新的版本
- 防止意外删除


## 复制

- 必须开启版本控制
- 跨区域复制 （Cross Region Replication CRR）
	- 降低访问延迟
- 同区域复制（Same Region Replication SRR）
	- Bucket聚合日志或在生产帐户和测试帐户之间执行实时复制非常有用
- S3 赋予适当的 IAM 权限
- 复制功能开启后，只会复制新的对象
- 旧对象复制需要使用批量复制
- 默认情况下不会复制有”删除标记“的对象，除非在设置中启用


## S3 的不同种类

### S3 标准-通用

- 99.99% 可用
- 用于频繁访问的数据
- 低延迟高吞吐量
- 可以承受2个并发设施故障

- 用例
	- 大数据分析
	- 移动的和游戏应用程序
	- 内容分发

### S3  Infrequent Access 标准IA低频访问

- 访问频率低，但访问速度快
- 成本比 S3 标准低


- S3 Standard Infrequent Access  标准低频访问
	- 99.9% 可用
	- 用例
		- 容灾恢复
		- 备份
- S3 One-Zone Infrequent Access  单可用区区低频访问
	- 99.999999999% 高持久性，在单个的可用区中
	- 99.5 的可用性
	- 用例
		- 存储备份的辅助副本，这些备份可能是内部数据, 也可能是您可以重新创建的数据
	

### S3 Glacier  冰川存储

- Glacier是一种低成本的对象存储， 用于归档和备份
- 支付存储费用和检索费用

- S3 Glacier Instant Retrieval  即时检索
	- ms 级完成检索
	- 最短存储时间 90 天

- S3 Glacier Flexible Retrieval 灵活检索
	- 快速：1-5 min 可恢复数据
	- 标准：3-5 小时
	- bulk：5 -12 小时
	- 最短存储时间 90 天

- S3 Glacier Deep Archive 深度存档
	- 标准：12 小时
	- bulk：48 小时
	- 最短存储时间 180天


### S3 智能分层

- 根据使用模式在多余的层之间移动对象
- 支付少量的监控费用和自动分层费用


- 频繁访问层，默认
- 不频繁访问层，超过30天未访问
- 归档即时访问层，90天
- 归档访问层（可选），90 - 700+天
- 深度归档访问层，180 - 700+ 天

## S3 持久性和可用性

- 持久性
	- 99.999999999% 11个9
	- 10000万个对象，一万年丢失一个对象
	- 所有种类的持久性都是一样的
- 可用性
	- 99.99%
	- 一年大约53分钟不可用


## 在不同存储类型中移动

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/2023-05-17-020943.png)


## S3 生命周期规则

- 使用生命周期规则自动完成分层

- 转换操作
	- 对象创建60天后，自动移动到 标准IA 低频访问
	- 对象创建6个月后，自动移动到 Glacier 中
- 到期操作
	- 设置日志在365天后删除
	- 可以设置删除旧版本文件
	- 可以删除多部分上传中不完整的文件
	- 可以根据前缀指定规则，可应用于整个buckets，或 buckets 中的特定路径
	- 可以根据标签指定规则


## S3 Analytics  - Storage Class Analysis 存储类型分析

- 可以提供标准和标准IA的建议
- 不适用于One-Zone IA或Glacier
- 它会创建一个CSV报告，它将为您提供一些建议和一些统计数据
- 报告将每天更新，然后可能需要24到48小时才能开始看到从中产生的数据分析


## S3 事件通知

- 事件是指创建对象，删除对象，恢复对象或发生复制等事件。
- 可以筛选事件
- 所有事件通过 eventbrige 转发
- 如果在同一时间对一个非版本的对象进行了两次写入，有可能只发送一次事件通知。如果你想确保每次成功写入都会发送事件通知，你可以在你的桶上启用版本控制。有了版本控制，每次成功写入都会为你的对象创建一个新的版本，也会发送事件通知。

- 可发送的目的地
	- Lambda 函数
	- SNS
	- SQS


## S3 基线性能

- 延迟 100 -200 ms
- 每秒可处理 3500 个 PUT/COPY/POST/DELETE
- 每秒可处理 5500 个 GET/HEAD 请求
- buckets 中不限制子路径的数量


### 性能优化

- 多部分上传
	- 超过 100MB 的文件推荐使用
	- 超过 5GB 必须使用
	- 多部分上传采用并行上传
- 传输加速
	- 通过 edge location
	- 同时兼容多部分上传
- 指定字节范围获取

## S3 select & Glacier select 检索、Glacier 检索

- 一般情况都是使用 sql 进行服务器端检索
- S3 select 会在返回应用之前进行筛选，返回较少的数据
	- 速度快400%
	- 价格便宜80%


## 用户定义的元数据、S3 对象标签


- 用户定义的元数据
	- 当上传一个对象时，可以给这个对象分配元数据
	- 元数据是附加到对象 key 值的名称
	- 名称必须以x-amz-meta开头
	- 所以元数据可以在检索对象的同时被检索
- S3 对象标签
	- S3 对象的键值对
	- 标签可用于更细粒度的权限控制

> **无法使用元数据和标签对S3 进行过滤**


 ## S3 对象加密

- 服务端加密 SSE 
	- SSE-S3
		- S3密钥的服务器端加密 (默认启用)
	- SSE-KMS
		- 用KMS密钥来管理加密密钥
	- SSE-C 
		- 使用客户提供的密钥
- 客户端加密


### SSE-S3

- AWS处理､管理和拥有的密钥
- 用户永远无法访问此密钥
- 在服务器端加密
- 加密算法为AES-256
- 必须设置请求头为“x-amz-server-side-encryption”：“AES“

### SSE-KMS

- 使用 KMS 自己管理密钥
- 在KMS中自己创建密钥，并且可以使用CloudTrail编辑密钥使用情况
- 必须设置请求头：“x-amz-server-side-encryption”的头：“aws：kms”
- 在服务器端加密

> KMS 的一些限制:
> - 上传文件时，需要调用 KMS 的 API
> - 这些调用会计入每秒调用 API 的限额中
> - 每个区域中，每秒有5000 - 30000 个请求配额
> - 可以通过 Service Quotas Console 提升配额


###  SSE-C

- 密钥是在AWS之外管理的
- 仍然是服务器端加密
- 将密钥发送到AWS，AWS 在使用后直接丢弃
- 必须使用 HTTPS 
- 上传和读取都需要传递密钥


### 客户端加密

- 直接使用 AWS S3 客户端加密库
- 客户端必须在上传之前对文件进行加密
- 客户端在接受 S3 的文件后进行解密
- 客户端完全管理密钥和加密周期


### 传输中加密 SSL / TLS

- 推荐使用 HTTPS
- SSE-C 必须使用  HTTPS


## CORS  跨资源共享

- Cross-Origin Resource Share
- Orgin = 协议 + 域名  + 端口 
- 同源：相同的协议、域名、端口
- 在 S3 上发出跨源请求，需要启用正确的CORS头


##  MFA Delete 

- 必须启用版本控制
- 需要 MFA 的情况
	- 删除对象的一个版本
	- 挂起存储桶上的版本控制
- 不需要  MFA 的情况
	- 启用版本控制
	- 列出已删除的版本


## S3 访问日志

- 记录对S3存储桶的所有访问
- 不要将日志记录存储桶设置为与您正在监视的存储桶相同，会导致循环记录

## S3 预签名URL

- 该URL的用户将继承生成GET或PUT的URL的用户的权限
- 最长可达12小时

## S3 接入点

- 用于定义不同的访问范围
- 接入点是比较简便的S3的安全策略
- 一般的接入点会：
	- 拥有自己的  DNS
	- 然后在附加一个与 bukcets 类似的策略
- 接入点可以链接VPC，使用VPC 访问 bukcets

## S3 对象 Lambda

- 目标 Bukcets 创建一个 S3 Lambda 的接入点
- 创建一个 lambda 函数执行一些操作
- 在 lambda 函数上创建一个接入点，提供给外部程序

- 运用
	- 个人信息加密
	- 格式转换
	- 动态图像大小
	- 添加水印

