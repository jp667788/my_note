### 自旋锁与自适应自旋
- 概念
	- 当一个线程获取锁失败时，可以进入一个忙循环，不放弃处理器执行时间，进而省去线程上下文切换
- 版本
	- JDK 1.4.2 引入 默认关闭
	- JDK 1.6 后默认开启
- 特点
	- 自旋等待不能代替阻塞
	- 虽然避免了线程上下文开销，但是会占用处理器时间
	- 如果锁占用时间短，效果就很好
	- 自选等待时间必须有一定的限度，默认10 次（-XX：PreBlockSpin）
- 自适应自旋
	- 自旋时间不固定，由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定
	- 同一个锁对象行，自旋等待刚刚成功获得过锁，虚拟机认为这次自旋很有可能成功，允许等待更长的时间
	- 相反，如果自旋很少获得过锁，那这个锁可能直接省略调自旋过程


### 锁消除
- 概念
	- 指虚拟机即时编译器，对一些要求同步的代码，检测到不可能存在共享数据竞争的锁进行消除
- 特点
	- 锁消除的判断依据主要来源于逃逸分析的数据支持
	- 如果一段代码中，在堆上所有的数据都不会逃逸出去被其他线程访问到，就可以认为线程私有
- 疑问
	- 程序员应该很清楚自己的代码是否存在数据竞争，为何还需要逃逸分析
	- 比如 s1 + s2 + s3 ，编译器会优化为 StringBuilder.append()，StringBuilder 内部通过 synchornized 线程安全

### 锁粗化
- 概念
	- 如果一系列连续操作都对同一个对象反复加锁和解锁，频繁的进行互斥同步操作也会导致性能消耗
	- 虚拟机探测到有这样的行为时，就会把锁同步的范围扩大

### 轻量级锁
- 概念
	- JDK 6 引入
	- 在没有多线程竞争的前提下，减少传统重量级锁的使用产生的性能消耗
	- 在没有竞争的情况下，使用 CAS 操作互斥操作的性能消耗
- 对象头
	- 第一部分
		- HashCode 25bit
		- GC 分代年龄 4 bit
		- 锁标志位 2 bit
		- 固定0 1bit
	- 第二部分
		- 对象实例数据
- 锁定状态
	- 无锁
	- 偏向锁
	- 轻量级锁
	- 重量级锁

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-21-172121.png)

- 工作流程
	- 加锁
		- 代码即将进入同步块时，如果同步对象没有被锁定（01状态）
		- 虚拟机在当前线程的栈帧中建立一个 Lock Record 的锁空间记录，用于拷贝 Mark Word （Displaced Mark Word）。此时线程堆栈与对象头状态如下图
		![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-21-172603.png)
		- 虚拟机使用 CAS 操作尝试把对象的 Mark Word 更新为指向 Lock Record 的指针
			- 更新成功，代表线程持有了对象锁，且状态位变成 00 ，如下图
			![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-21-173150.png)

			- 更新失败，代表至少存在一条线程参与竞争
				- 检查对象的 Mark word 是否指向当前线程的栈帧
					- 是，则代表当前线程已经持有该对戏是哪个的锁
					- 否，则代表锁对象已被其他线程抢占
				- 如果出现两条以上线程竞争同一个对象锁，轻量级锁失效
					- 膨胀为重量级锁，状态变为 10
		- 解锁
			- 如果对象的 Mark Word 仍然指向线程的锁记录
				- CAS 把当前对象的Mark Word 和线程中的 Lock Reocrd 中的 Displaced Mark Word 做替换
					- 替换成功，锁释放成功，同步完成
					- 替换失败，说明有其他线程尝试获取锁，释放锁的同时，唤醒被挂起的线程
	- 特点
		- 基于 “绝大部分锁，在整个同步过程不存在竞争” 的经验
		- 没有竞争下，通过 CAS 操作避免了使用互斥锁的开销
		- 有竞争力下，额外发生了 CAS 操作，反而更慢


### 偏向锁
- 概念
	- JDK 1.6 引入
	- 消除数据在无竞争情况下的同步原语句
	- 是在无竞争的情况下，消除整个同步过程，CAS 都不会做
	- 锁会偏向第一个获得它的线程

- 工作过程
	- 锁对象第一次被线程获取时
		- 虚拟机会把对象头中的锁标志位设置为 01
		- 把偏向模式设为 1，标识进入偏向模式
		- 使用 CAS 操作吧线程ID 记录在 Mark Word 中
			- 如果 CAS 成功，持有偏向锁的线程以后每次进入这个锁相关的同步块都不需要加锁操作
			- 一旦出现另外一个线程去尝试获取这个锁，**偏向模式结束**
				- 根据锁对象目前是否被锁定的状态，决定是否撤销偏向（飘向模式设为0）
				- 撤销后，锁状态回复到无锁状态 01，或轻量级锁 00
				- 后续按照轻量级锁步骤执行

![](https://mynoteimage.oss-cn-beijing.aliyuncs.com/note/2022-03-21-174736.png)